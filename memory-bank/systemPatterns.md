# システムパターン

## アーキテクチャ

- **ソースコード:** TypeScriptで記述され、機能ごとにモジュール (`src/`
  ディレクトリ内) に分割されています。
- **ビルドプロセス:** Deno (`build.ts` スクリプト)
  を使用して、TypeScriptコードとCSSを単一のスタンドアロンHTMLファイル
  (`csv_date_expander.html`) にバンドルします。
- **実行:**
  最終的なHTMLファイルは、ユーザーのブラウザ上でクライアントサイドJavaScriptとして実行されます。サーバーサイドの処理は一切ありません。

## 主要な技術要素とパターン

- **言語:** TypeScript
- **ランタイム/ビルドツール:** Deno
- **モジュールシステム:** ES Modules (`import`/`export`)
- **バンドル:** Denoの `bundle` 機能 (現在は `deno_emit` モジュール経由)
  を使用して、依存関係を含むTypeScriptコードを単一のJavaScriptファイルにまとめます。
- **DOM操作:** 標準のDOM
  APIを使用してHTML要素の取得、イベントリスナーの設定、UIの更新を行います
  (`src/domHandler.ts`)。
- **ファイルAPI:** `FileReader` APIを使用します。
  - ファイルは `readAsArrayBuffer()` を使用してバイナリとして読み込まれます。
  - 読み込み後、`TextDecoder` API
    を使用してエンコーディングを自動検出・デコードします。
    - UTF-8 BOM があれば UTF-8 としてデコード。
    - BOM がなければ Shift_JIS としてデコードを試行 (`fatal: true`)。
    - Shift_JIS で失敗した場合、UTF-8 としてデコードを試行 (`fatal: true`)。
    - 失敗した場合はエラーとして扱います。
- **CSV処理:** カスタム関数 (`src/csvParser.ts`)
  を使用して、CSVテキストの解析と生成を行います。基本的なケースに対応し、生成時にはフィールドのエスケープ処理を行います。
- **日付処理:** カスタム関数 (`src/dateUtils.ts`)
  を使用して、複数の形式（"M月D日" を含む）の日付文字列を解析し、"YYYY/MM/DD"
  形式にフォーマットします。内部的にUTCを使用してタイムゾーンの問題を回避します。
- **イベント駆動:**
  - ボタンクリックやファイル選択、ドラッグ＆ドロップなどのユーザーインタラクションは、標準のDOMイベントリスナー
    (`addEventListener`) によって処理されます (`src/domHandler.ts`
    で設定し、`src/main.ts` でコールバックを定義)。
  - ファイル選択 (`<input type="file">` の `change` イベント)
    およびファイルドロップ (`dragover`, `dragleave`, `drop` イベント)
    時には、ファイル情報を一時的に保持し、UIにファイル名を表示します。
  - 実際のCSV処理は、「処理実行」ボタンのクリックイベントによってトリガーされます。
- **エラーハンドリングとフィードバック:**
  - 致命的なエラー（ファイル未選択、列番号不正、読み込み失敗等）は、UIのエラー表示領域
    (`<div id="error">`) に表示されます。
  - 行ごとの警告（日付解析失敗、日付範囲不正、列数不足、上限による打ち切り等）は、処理完了後に詳細情報（行番号、理由、関連データ）がUIの警告詳細リスト
    (`<div id="warningDetails">`) に表示されます。
  - 処理全体のステータス（完了メッセージ、警告の件数サマリー）は、UIのステータス表示領域
    (`<div id="status">`) に表示されます。
  - (`src/domHandler.ts`, `src/main.ts` で実装)
- **データダウンロード:** 生成されたCSVデータは `Blob`
  オブジェクトとして作成され、一時的なURL (`URL.createObjectURL`)
  を生成してダウンロードリンクとして提供されます。UTF-8 BOMが付加されます。
- **スタイリング:** プレーンなCSS (`src/style.css`)
  を使用し、ビルド時にHTMLファイル内に `<style>`
  タグとしてインライン化されます。
