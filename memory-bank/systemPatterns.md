# システムパターン

## アーキテクチャ

- **ソースコード:** TypeScriptで記述され、機能ごとにモジュール (`src/`
  ディレクトリ内) に分割されています。
- **ビルドプロセス (Web UI):** Deno (`build.ts` スクリプト)
  を使用して、TypeScriptコードとCSSを単一のスタンドアロンHTMLファイル
  (`csv_date_expander.html`) にバンドルします。
- **実行 (Web UI):**
  最終的なHTMLファイルは、ユーザーのブラウザ上でクライアントサイドJavaScriptとして実行されます。サーバーサイドの処理は一切ありません。
- **実行 (CLI):**
  - `cli.ts` ファイルは Deno ランタイムを使用して直接実行されます。
  - **デフォルト動作:**
    標準入力からCSVデータを読み込み、処理結果を標準出力に書き込みます。
  - **オプション:** `--input` で入力ファイル、`--output`
    で出力ファイルを指定できます。
  - Web UIとは独立して動作します。

## 主要な技術要素とパターン

- **言語:** TypeScript
- **ランタイム/ビルドツール:** Deno
- **モジュールシステム:** ES Modules (`import`/`export`)
- **バンドル (Web UI):** Denoの `bundle` 機能 (現在は `deno_emit`
  モジュール経由)
  を使用して、依存関係を含むTypeScriptコードを単一のJavaScriptファイルにまとめます。
- **DOM操作 (Web UI):** 標準のDOM
  APIを使用してHTML要素の取得、イベントリスナーの設定、UIの更新を行います
  (`src/domHandler.ts`)。
- **ファイルAPI (Web UI):** `FileReader` APIを使用します。
  - ファイルは `readAsArrayBuffer()` を使用してバイナリとして読み込まれます。
  - 読み込み後、`TextDecoder` API
    を使用してエンコーディングを自動検出・デコードします。
    - UTF-8 BOM があれば UTF-8 としてデコード。
    - BOM がなければ **UTF-8 (BOMなし)** としてデコードを試行 (`fatal: true`)。
    - UTF-8 (BOMなし) で失敗した場合、Shift_JIS としてデコードを試行
      (`fatal: true`)。
    - 失敗した場合はエラーとして扱います。
- **入出力 (CLI):** Deno の標準ライブラリを使用します。
  - **入力:**
    - `--input` 指定時: `Deno.readFile` でファイルをバイナリとして読み込みます。
    - `--input` 省略時: `readAll(Deno.stdin)` で標準入力から読み込みます。
  - **デコード:** `TextDecoder` API でエンコーディングを自動検出・デコードします
    (Web UI と同様のロジック、UTF-8優先)。
  - **出力:**
    - `--output` 指定時: `Deno.writeFile` で処理結果をファイルに書き込みます
      (UTF-8 BOM付き)。
    - `--output` 省略時: `Deno.stdout.write` で処理結果を標準出力に書き込みます
      (BOMなし)。
- **コマンドライン引数処理 (CLI):** Deno の `std/flags/parse_args.ts`
  (`parseArgs`)
  を使用して、入力/出力ファイルパス、日付列番号、展開上限、各種フラグ
  (`--verbose`, `--version`, `--help`) などの引数を解析します。
- **CSV処理:** カスタム関数 (`src/csvParser.ts`)
  を使用して、CSVテキストの解析と生成を行います。基本的なケースに対応し、生成時にはフィールドのエスケープ処理を行います。(Web
  UI / CLI 共通)
- **日付処理:** カスタム関数 (`src/dateUtils.ts`)
  を使用して、複数の形式（"M月D日" を含む）の日付文字列を解析し、"YYYY/MM/DD"
  形式にフォーマットします。内部的にUTCを使用してタイムゾーンの問題を回避します。(Web
  UI / CLI 共通)
- **イベント駆動 (Web UI):**
  - ボタンクリックやファイル選択、ドラッグ＆ドロップなどのユーザーインタラクションは、標準のDOMイベントリスナー
    (`addEventListener`) によって処理されます (`src/domHandler.ts`
    で設定し、`src/main.ts` でコールバックを定義)。
  - ファイル選択 (`<input type="file">` の `change` イベント)
    およびファイルドロップ (`dragover`, `dragleave`, `drop` イベント)
    時には、ファイル情報を一時的に保持し、UIにファイル名を表示します。
  - 実際のCSV処理は、「処理実行」ボタンのクリックイベントによってトリガーされます。
- **エラーハンドリングとフィードバック (Web UI):**
  - 致命的なエラー（ファイル未選択、列名不正、読み込み失敗等）は、UIのエラー表示領域
    (`<div id="error">`) に表示されます。
  - 行ごとの警告（日付解析失敗、日付範囲不正、列数不足、上限による打ち切り等）は、処理完了後に詳細情報（行番号、理由、関連データ）がUIの警告詳細リスト
    (`<div id="warningDetails">`) に表示されます。
  - 処理全体のステータス（完了メッセージ、警告の件数サマリー）は、UIのステータス表示領域
    (`<div id="status">`) と結果サマリー領域 (`<div id="resultSummary">`)
    に表示されます。
  - 処理中の状態は、ローディングインジケーター
    (`<div id="processingIndicator">`) で視覚的に表示されます。
  - (`src/domHandler.ts`, `src/main.ts` で実装)
- **エラーハンドリングとフィードバック (CLI):**
  - 引数エラー、入出力エラー、処理中のエラーなどは `console.error`
    を使用して**標準エラー出力**に表示されます。
  - **終了コード:** エラーの種類に応じて異なる終了コード (0: 成功, 1:
    引数/使用法エラー, 2: I/Oエラー, 3: 処理エラー) を返します。
  - **警告:** 処理中の警告 (日付解析失敗など) も `console.error`
    を使用して標準エラー出力に表示されます。
  - **詳細ログ:** `--verbose`
    フラグが指定された場合、処理の進行状況などの詳細情報が `console.error`
    を使用して標準エラー出力に表示されます。
- **データダウンロード (Web UI):** 生成されたCSVデータは `Blob`
  オブジェクトとして作成され、一時的なURL (`URL.createObjectURL`)
  を生成してダウンロードリンクとして提供されます。UTF-8 BOMが付加されます。
- **スタイリング (Web UI):**
  - モダンなCSSデザインシステム (`src/style.css`)
    を使用し、CSS変数を活用して一貫性のあるスタイリングを実現しています。
  - カード型レイアウトとステップ構造を採用し、ユーザーの操作フローを視覚的に明確化しています。
  - アイコンを活用して視覚的な分かりやすさを向上させています。
  - レスポンシブデザインを採用し、様々な画面サイズに対応しています。
  - ビルド時にHTMLファイル内に `<style>` タグとしてインライン化されます。
- **ユーザー体験の向上 (Web UI):**
  - ファイルプレビュー機能により、選択したCSVファイルの内容を確認できます。
  - 処理状態の視覚的フィードバックにより、処理の進行状況を把握できます。
  - エラーと警告の視覚的な区別により、問題の重要度を把握できます。
  - 折りたたみ可能なヘルプセクションにより、必要に応じて使い方を確認できます。
