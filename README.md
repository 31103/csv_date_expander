# CSV 日付展開ツール

## 概要

このツールは、指定された開始日と終了日の列を含むCSVファイルを処理し、各行を開始日から終了日までの日付ごとに展開するアプリケーションです。**HTMLベースのWebアプリケーションとして、またはCLIツールとして利用できます。**

例えば、あるタスクの開始日と終了日が1行で記録されているCSVを、日別のタスク行に変換したい場合などに使用できます。

**Webアプリケーション版では、処理はすべてブラウザ上で完結するため、サーバーへのデータ送信は行われません。CLI版ではローカル環境で処理が実行されます。**

## 主な機能

- **CSVファイルの選択 (ドラッグ&ドロップ対応) [Web版]:**
  ローカルからCSVファイルを読み込みます。ファイル選択ダイアログまたは指定エリアへのドラッグ&ドロップでファイルを選択できます。
- **選択ファイル名の表示 [Web版]:** 選択されたCSVファイル名が表示されます。
- **列名の選択 [Web版/CLI版]:**
  ファイル読み込み後、ヘッダー行から取得した列名をドロップダウンリスト[Web版]またはコマンドライン引数[CLI版]で選択して、開始日と終了日が含まれる列を指定できます。
- **日付範囲に基づく行の展開 [Web版/CLI版]:**
  各データ行を、指定された開始日から終了日まで1日ずつ、行を複製して展開します。
- **新規日付列の追加 [Web版/CLI版]:** 展開後のCSVの先頭に `EXPANDDATE`
  という名前の列を追加し、対応する日付 (`YYYY/MM/DD` 形式) を挿入します。
- **展開行数上限の設定 [Web版/CLI版]:**
  1つの元データ行から展開される行数（日数）の上限を設定できます（デフォルト:
  365）。上限を超えた場合、その行の展開は上限日数で打ち切られ、警告が表示されます。
- **処理結果のダウンロード [Web版] / ファイル出力 [CLI版]:**
  展開後のデータをCSVファイルとしてダウンロード[Web版]または指定ファイルに出力[CLI版]できます。
- **内部処理の効率化:** ファイル選択時のデータ読み込みを最適化しました[Web版]。

## 開発環境

- **必須:** [Deno](https://deno.com/) ランタイム (バージョン 1.x または 2.x) -
  CLI版の実行、およびWeb版の開発・ビルドに必要です。
- **推奨:** コードエディタ (VS Codeなど、Deno拡張機能があると便利です)

## プロジェクト構造

```
.
├── src/                  # Webアプリケーションのソースコードディレクトリ
│   ├── main.ts           # アプリケーションのエントリポイント、メインロジック
│   ├── domHandler.ts     # DOM操作、UI更新、イベントリスナー設定
│   ├── csvParser.ts      # CSVの解析と生成 (Web用)
│   ├── dateUtils.ts      # 日付の解析とフォーマット (Web用)
│   └── style.css         # アプリケーションのスタイルシート
├── cli.ts                # CLIツールのエントリポイント
├── build.ts              # ビルドスクリプト (Webアプリケーション用)
├── index.html            # HTMLテンプレート (ビルド時に使用)
├── csv_date_expander.html # ビルド後の成果物 (スタンドアロンHTML)
├── README.md             # このファイル
└── memory-bank/          # プロジェクトコンテキスト (開発用)
    ├── ...
```

## 使い方

### Webアプリケーション版

1. **ビルド:**
   プロジェクトのルートディレクトリで以下のコマンドを実行し、`csv_date_expander.html`
   を生成します。
   ```bash
   deno run --allow-read --allow-write --allow-net --allow-env build.ts
   ```
2. **実行:** 生成された `csv_date_expander.html` をWebブラウザで開きます。
3. **ファイル選択:** 「1.
   CSVファイルを選択」ボタンをクリックするか、エリアにCSVファイルをドラッグ＆ドロップします。
4. **列選択:** 開始日と終了日の列名をドロップダウンから選択します。
5. **上限設定:** 展開行数の上限を設定します（デフォルト: 365）。
6. **処理実行:** 「処理実行」ボタンをクリックします。
7. **ダウンロード:** 処理完了後、「結果をダウンロード
   (CSV)」ボタンをクリックして結果を取得します。

### CLIツール版

「CLIツールの使い方」セクションを参照してください。CLIツールはビルド不要で直接実行できます。

## CLIツールの使い方

`cli.ts` スクリプトを直接 Deno で実行します。

### 実行に必要な権限

ファイルの読み込みと書き込みのために、以下の権限が必要です。

```bash
deno run --allow-read --allow-write cli.ts [オプション]
```

### 基本的なコマンド実行例

```bash
deno run --allow-read --allow-write cli.ts --file input.csv --start-col "開始日" --end-col "終了日" --output output.csv
```

### 引数

#### 必須引数

- `--file <ファイルパス>`: 処理対象のCSVファイルへのパスを指定します。
- `--start-col <列名>`: 開始日が記載されている列のヘッダー名を指定します。
- `--end-col <列名>`: 終了日が記載されている列のヘッダー名を指定します。

#### オプション引数

- `--limit <数値>`: 1つの元データ行から展開される行数（日数）の上限を指定します
  (デフォルト: 365)。
- `--output <ファイルパス>`:
  出力ファイル名を指定します。指定しない場合は、`元のファイル名_expanded.csv`
  という名前で元のファイルと同じディレクトリに出力されます。
- `--help`: ヘルプメッセージを表示します。

## 入力CSVフォーマット

- 文字コード: **UTF-8 (BOMあり/なし) または Shift_JIS** を自動的に検出します。
- 1行目: **ヘッダー行** として扱われます。
- 区切り文字: **カンマ (,)**
- 日付列:
  - 指定された開始日・終了日の列には、日付として解釈可能な文字列が含まれている必要があります。
  - 対応している主な日付形式:
    - `YYYY/MM/DD`
    - `YYYY-MM-DD`
    - `YYYY.MM.DD`
    - `M月D日` (年は実行時の現在の年として扱われます)
  - 上記以外の形式でも、JavaScriptの `Date`
    オブジェクトが解釈できれば処理される可能性がありますが、予期しない結果になる場合があります。

**入力例 (`exapmle.csv`)**

```csv
ID,開始日,終了日,備考
A001,2025/04/01,2025/04/03,テストデータ1
B002,4月5日,4月6日,テストデータ2
```

## 出力CSVフォーマット

- 文字コード: UTF-8 (BOM付き)
- 1行目: 元のヘッダー行の先頭に `EXPANDDATE` が追加されたヘッダー行。
- 2行目以降: 元の各行が、開始日から終了日までの日数分展開されたデータ。
- `EXPANDDATE` 列には、展開された各行に対応する日付 (`YYYY/MM/DD` 形式)
  が入ります。
- 元の行の他の列データはそのまま複製されます。

**出力例 (exapmle_expanded.csv)**

```csv
EXPANDDATE,ID,開始日,終了日,備考
2025/04/01,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/02,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/03,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/05,B002,4月5日,4月6日,テストデータ2
2025/04/06,B002,4月5日,4月6日,テストデータ2
```

## 注意点・制限事項

### Webアプリケーション版

- **実行環境:** ビルドされた `csv_date_expander.html` はモダンブラウザ (Chrome,
  Firefox, Edgeなど) で動作します。
- **大規模ファイル:**
  非常に大きなCSVファイル（数万行以上など）を処理すると、ブラウザのメモリ制限や処理速度の問題で動作が不安定になる可能性があります。

### CLIツール版

- **実行環境:** CLIツールの実行には **Deno** ランタイム (バージョン 1.x または
  2.x) が必要です。
- **大規模ファイル:**
  CLI版はブラウザ版よりも大きなファイルを扱える可能性がありますが、システムのメモリ量に依存します。

### 共通

- **開発環境:** コードの変更やWebアプリケーション版の再ビルドには **Deno**
  が必要です。
- **CSV解析:**
  簡易的なCSVパーサーを使用しています。基本的なケースには対応しますが、複雑なエスケープを含むCSVでは問題が発生する可能性があります。
- **日付解析:** `M月D日`
  形式の日付は、ツールを実行した時点の現在の年として解釈されます。年をまたぐ期間などで意図しない結果になる場合は、入力CSVの日付を`YYYY/MM/DD`
  形式にしてください。日付として解釈できない文字列が含まれる行、開始日が終了日より後の行はスキップされます。指定された上限日数を超える期間を持つ行は、上限日数まで展開された後、残りの日付の展開が打ち切られます。スキップされた行や打ち切られた行の詳細は、Web版では処理完了後に画面下部の警告リストに、CLI版では標準エラー出力に表示される場合があります。
