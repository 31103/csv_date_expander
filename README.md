# CSV 日付展開ツール

## 概要

このツールは、指定された開始日と終了日の列を含むCSVファイルを処理し、各行を開始日から終了日までの日付ごとに展開するHTMLベースのアプリケーションです。

例えば、あるタスクの開始日と終了日が1行で記録されているCSVを、日別のタスク行に変換したい場合などに使用できます。

処理はすべてブラウザ上で完結するため、サーバーへのデータ送信は行われません。

## 主な機能

- **CSVファイルのアップロード:** ローカルからCSVファイルを読み込みます。
- **列番号の指定:**
  開始日と終了日が含まれる列を番号（1から始まるインデックス）で指定できます。
- **日付範囲に基づく行の展開:**
  各データ行を、指定された開始日から終了日まで1日ずつ、行を複製して展開します。
- **新規日付列の追加:** 展開後のCSVの先頭に `EXPANDDATE`
  という名前の列を追加し、対応する日付 (`YYYY/MM/DD` 形式) を挿入します。
- **展開行数上限の設定:**
  1つの元データ行から展開される行数（日数）の上限を設定できます（デフォルト:
  100）。期間が長すぎる行はスキップされます。
- **処理結果のダウンロード:**
  展開後のデータをCSVファイルとしてダウンロードできます。

## 開発環境

- **必須:** [Deno](https://deno.com/) ランタイム (バージョン 1.x または 2.x)
- **推奨:** コードエディタ (VS Codeなど、Deno拡張機能があると便利です)

## プロジェクト構造

```
.
├── src/                  # ソースコードディレクトリ
│   ├── main.ts           # アプリケーションのエントリポイント、メインロジック
│   ├── domHandler.ts     # DOM操作、UI更新、イベントリスナー設定
│   ├── csvParser.ts      # CSVの解析と生成
│   ├── dateUtils.ts      # 日付の解析とフォーマット
│   └── style.css         # アプリケーションのスタイルシート
├── build.ts              # ビルドスクリプト (Denoで実行)
├── index.html            # HTMLテンプレート (ビルド時に使用)
├── csv_date_expander.html # ビルド後の成果物 (スタンドアロンHTML)
├── README.md             # このファイル
└── memory-bank/          # プロジェクトコンテキスト (開発用)
    ├── ...
```

## ビルド方法

プロジェクトのルートディレクトリで以下のコマンドを実行します。

```bash
deno run --allow-read --allow-write --allow-net --allow-env build.ts
```

これにより、`src/`
ディレクトリ内のTypeScriptコードとCSSがバンドルされ、`index.html`
テンプレートに埋め込まれた `csv_date_expander.html` が生成されます。

## 使い方 (ビルド後のファイル)

1. 上記のビルドコマンドを実行して `csv_date_expander.html` を生成します。
2. 生成された `csv_date_expander.html` をWebブラウザで開きます。
3. **「1. CSVファイルを選択」**
   ボタンをクリックし、処理したいCSVファイルを選択します。
4. **「2. 開始日の列番号」**
   に、CSVファイル内で開始日が記載されている列の番号（1から始まる番号）を入力します。
5. **「3. 終了日の列番号」**
   に、CSVファイル内で終了日が記載されている列の番号（1から始まる番号）を入力します。
6. **「4. 展開行数上限」**
   に、1行あたりに展開する最大日数を入力します（必要に応じて変更、デフォルトは100）。
7. **「処理実行」** ボタンをクリックします。
8. 処理が正常に完了すると、ステータスメッセージと **「結果をダウンロード
   (CSV)」** ボタンが表示されます。
   - エラーが発生した場合や、処理中にスキップされた行がある場合は、エラーメッセージや警告の詳細が画面下部に表示されます。
9. **「結果をダウンロード (CSV)」** ボタンをクリックすると、処理結果が
   `元のファイル名_expanded.csv` という名前でダウンロードされます。

## 入力CSVフォーマット

- 文字コード: **UTF-8 (BOMあり/なし) または Shift_JIS** を自動的に検出します。
- 1行目: **ヘッダー行** として扱われます。
- 区切り文字: **カンマ (,)**
- 日付列:
  - 指定された開始日・終了日の列には、日付として解釈可能な文字列が含まれている必要があります。
  - 対応している主な日付形式:
    - `YYYY/MM/DD`
    - `YYYY-MM-DD`
    - `YYYY.MM.DD`
    - `M月D日` (年は実行時の現在の年として扱われます)
  - 上記以外の形式でも、JavaScriptの `Date`
    オブジェクトが解釈できれば処理される可能性がありますが、予期しない結果になる場合があります。

**入力例 (`exapmle.csv`)**

```csv
ID,開始日,終了日,備考
A001,2025/04/01,2025/04/03,テストデータ1
B002,4月5日,4月6日,テストデータ2
```

## 出力CSVフォーマット

- 文字コード: UTF-8 (BOM付き)
- 1行目: 元のヘッダー行の先頭に `EXPANDDATE` が追加されたヘッダー行。
- 2行目以降: 元の各行が、開始日から終了日までの日数分展開されたデータ。
- `EXPANDDATE` 列には、展開された各行に対応する日付 (`YYYY/MM/DD` 形式)
  が入ります。
- 元の行の他の列データはそのまま複製されます。

**出力例 (exapmle_expanded.csv)**

```csv
EXPANDDATE,ID,開始日,終了日,備考
2025/04/01,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/02,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/03,A001,2025/04/01,2025/04/03,テストデータ1
2025/04/05,B002,4月5日,4月6日,テストデータ2
2025/04/06,B002,4月5日,4月6日,テストデータ2
```

## 注意点・制限事項

- **実行環境:** ビルドされた `csv_date_expander.html` はモダンブラウザ (Chrome,
  Firefox, Edgeなど) で動作します。
- **開発環境:** コードの変更や再ビルドには **Deno** が必要です。
- **大規模ファイル:**
  非常に大きなCSVファイル（数万行以上など）を処理すると、ブラウザのメモリ制限や処理速度の問題で動作が不安定になる可能性があります。
- **CSV解析:**
  簡易的なCSVパーサーを使用しています。基本的なケースには対応しますが、複雑なエスケープを含むCSVでは問題が発生する可能性があります。
- **日付解析:** `M月D日`
  形式の日付は、ツールを実行した時点の現在の年として解釈されます。年をまたぐ期間などで意図しない結果になる場合は、入力CSVの日付を`YYYY/MM/DD`
  形式にしてください。日付として解釈できない文字列が含まれる行、開始日が終了日より後の行、指定された上限日数を超える行はスキップされます。スキップされた行の詳細は、処理完了後に画面下部の警告リストに表示されます。
